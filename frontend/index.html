<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admit-assist | Premium Student Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #fdfdfd; 
      --fg: #1c1917; 
      --card: rgba(255, 255, 255, 0.6);
      --primary: #79A3C3; 
      --primary-fg: #FFFFFF;
      --border: rgba(0, 0, 0, 0.06);
      --sidebar-bg: #2d221e; 
      --sidebar-fg: #f5f0ee;
      --sidebar-muted: rgba(245, 240, 238, 0.5);
      --sidebar-accent: #79A3C3;
      --radius: 1.5rem;
      --mesh-1: hsla(202, 60%, 92%, 1);
      --mesh-2: hsla(25, 60%, 90%, 1);
      --bubble-ai: #ffffff;
      --input-bg: #ffffff;
    }

    body.dark-mode {
      --bg: #0c0a09; 
      --fg: #f5f0ee; 
      --card: rgba(28, 25, 23, 0.6); 
      --border: rgba(255, 255, 255, 0.06);
      --mesh-1: #1a171e; 
      --mesh-2: #261b18; 
      --bubble-ai: #1c1917;
      --input-bg: #1c1917;
      --sidebar-bg: #141211;
    }

    body {
      font-family: 'Plus Jakarta Sans', system-ui, sans-serif;
      background-color: var(--bg);
      background-image: 
        radial-gradient(at 0% 0%, var(--mesh-1) 0px, transparent 50%),
        radial-gradient(at 100% 0%, var(--mesh-2) 0px, transparent 50%),
        radial-gradient(at 100% 100%, var(--mesh-1) 0px, transparent 50%),
        radial-gradient(at 0% 100%, var(--mesh-2) 0px, transparent 50%);
      color: var(--fg);
      height: 100vh;
      overflow: hidden;
      transition: all 0.5s ease;
    }

    .layout { display: flex; height: 100vh; padding: 24px; gap: 24px; }

    .sidebar {
      width: 340px;
      min-width: 340px;
      background: var(--sidebar-bg);
      display: flex; flex-direction: column;
      flex-shrink: 0;
      border-radius: var(--radius);
      transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
      backdrop-filter: blur(40px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    .sidebar.closed { margin-left: -364px; opacity: 0; pointer-events: none; }

    .sidebar-header { padding: 32px 24px 20px; display: flex; align-items: center; gap: 16px; }
    .scroll-area { flex: 1; overflow-y: auto; padding: 0 16px 20px; scrollbar-width: none; }
    .scroll-area::-webkit-scrollbar { display: none; }

    .id-card-preview {
      background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 16px;
      margin: 0 8px 12px;
      display: flex;
      align-items: center; gap: 16px;
    }
    .id-photo { width: 56px; height: 56px; border-radius: 14px; background: rgba(255,255,255,0.1); overflow: hidden; }
    .id-photo img { width: 100%; height: 100%; object-fit: cover; }
    .id-info h4 { font-size: 14px; color: #fff; font-weight: 700; }
    .id-info p { font-size: 10px; color: var(--sidebar-muted); font-weight: 800; letter-spacing: 0.05em; }

    .risk-alert-box {
        display: none;
        background: rgba(239, 83, 80, 0.15);
        border: 1px solid rgba(239, 83, 80, 0.3);
        border-radius: 16px;
        padding: 12px;
        margin: 0 8px 24px;
        align-items: center;
        gap: 10px;
        animation: msgFade 0.5s ease;
    }
    .risk-alert-box.active { display: flex; }
    .risk-text { font-size: 11px; font-weight: 800; color: #ff8a80; text-transform: uppercase; letter-spacing: 0.02em; }

    .sidebar-label { font-size: 10px; font-weight: 800; color: var(--sidebar-muted); text-transform: uppercase; letter-spacing: 0.1em; padding: 0 12px 12px; }

    .checklist { list-style: none; margin-bottom: 32px; }
    .checklist li button {
      width: 100%; display: flex; align-items: center; gap: 12px;
      padding: 12px 14px; border-radius: 12px; border: 1px solid transparent; background: transparent;
      font-size: 13px; font-weight: 600; color: rgba(245, 240, 238, 0.7);
      cursor: pointer; transition: 0.2s;
    }
    .checklist li button:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .checklist li button.done { color: #fff; background: rgba(121, 163, 195, 0.12); }
    .check-mark { width: 18px; height: 18px; border-radius: 6px; border: 2px solid rgba(255,245,238,0.2); flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
    .done .check-mark { background: var(--sidebar-accent); border-color: var(--sidebar-accent); }

    .planner-widget { background: rgba(255,255,255,0.03); border-radius: 18px; padding: 16px; border: 1px solid rgba(255,255,255,0.05); margin: 0 8px 24px; }
    .planner-item { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 10px; font-size: 12px; color: #fff; font-weight: 600; margin-bottom: 6px; }
    .add-course-form { display: flex; gap: 8px; margin-top: 12px; }
    .add-course-form input { flex: 1; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 6px 12px; color: #fff; font-size: 11px; outline: none; }
    .add-course-form button { background: var(--sidebar-accent); border: none; border-radius: 8px; width: 30px; color: #fff; cursor: pointer; font-weight: 800; }

    .sidebar-footer { padding: 24px; border-top: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; gap: 14px; }
    .avatar { width: 44px; height: 44px; border-radius: 14px; background: var(--sidebar-accent); display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 800; cursor: pointer; overflow: hidden; }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }

    .chat { flex: 1; display: flex; flex-direction: column; background: var(--card); border-radius: var(--radius); backdrop-filter: blur(30px); border: 1px solid var(--border); overflow: hidden; box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.05); transition: all 0.5s ease; }
    .chat-header { display: flex; align-items: center; gap: 16px; padding: 0 40px; height: 100px; border-bottom: 1px solid var(--border); }
    .weather-info { font-size: 12px; font-weight: 700; color: var(--fg); opacity: 0.6; display: flex; align-items: center; gap: 6px; margin-left: 20px; }
    
    .deadline-header-box {
        display: flex; align-items: center; gap: 8px;
        padding: 6px 14px; background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border); border-radius: 12px; margin-left: 20px;
    }
    .deadline-header-box .label { font-size: 10px; font-weight: 800; text-transform: uppercase; color: var(--fg); opacity: 0.5; letter-spacing: 0.05em; }
    .deadline-header-box .time { font-size: 12px; font-weight: 800; color: #ef5350; }

    .btn-theme { margin-left: auto; background: var(--fg); color: var(--bg); border: none; padding: 10px 24px; border-radius: 12px; font-weight: 800; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; transition: 0.3s; }

    .messages { flex: 1; overflow-y: auto; padding: 40px; display: flex; flex-direction: column; gap: 32px; scroll-behavior: smooth; }
    
    .ai-badge {
        font-size: 10px; font-weight: 800; color: var(--primary);
        text-transform: uppercase; letter-spacing: 0.05em;
        margin-bottom: 8px; display: flex; align-items: center; gap: 6px;
    }
    .source-tag { font-size: 9px; opacity: 0.6; background: rgba(121, 163, 195, 0.1); padding: 2px 8px; border-radius: 6px; border: 1px solid rgba(121, 163, 195, 0.2); }

    .bubble { max-width: 60%; padding: 18px 24px; font-size: 15px; font-weight: 500; border-radius: 24px 24px 24px 8px; background: var(--bubble-ai); border: 1px solid var(--border); line-height: 1.6; box-shadow: 0 4px 12px rgba(0,0,0,0.02); }
    .bubble.user { background: var(--sidebar-bg); color: #fff; border-radius: 24px 24px 6px 24px; border: none; }

    .quick-chips { display: flex; gap: 10px; padding: 0 40px 16px; overflow-x: auto; scrollbar-width: none; }
    .quick-chips button { background: var(--card); color: var(--fg); border: 1px solid var(--border); padding: 8px 16px; border-radius: 12px; font-size: 12px; font-weight: 700; cursor: pointer; transition: 0.2s; white-space: nowrap; }
    .quick-chips button:hover { background: var(--sidebar-bg); color: #fff; }

    .chat-input-area { padding: 0 40px 32px; position: relative; }
    .input-wrap { display: flex; align-items: center; gap: 12px; background: var(--input-bg); border-radius: 20px; padding: 8px 8px 8px 18px; border: 1px solid var(--border); box-shadow: 0 8px 20px rgba(0,0,0,0.02); }
    .input-wrap input { flex: 1; border: none; outline: none; font-size: 15px; font-weight: 600; color: var(--fg); background: transparent; }
    .btn-upload { width: 44px; height: 44px; border-radius: 14px; border: none; background: transparent; color: var(--fg); cursor: pointer; opacity: 0.5; transition: 0.2s; }
    .btn-send { width: 44px; height: 44px; border-radius: 14px; border: none; background: var(--sidebar-bg); color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; }

    .escalation-wrap { text-align: center; margin-top: 12px; }
    .escalation-link { background: none; border: none; color: var(--fg); opacity: 0.4; font-size: 11px; font-weight: 700; text-decoration: underline; cursor: pointer; transition: 0.2s; }
    
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px); z-index: 9999; justify-content: center; align-items: center; }
    .modal-content { background: var(--sidebar-bg); color: #fff; padding: 32px; border-radius: 24px; max-width: 400px; text-align: center; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
    .modal-btn { margin-top: 20px; background: var(--sidebar-accent); color: #fff; border: none; padding: 10px 24px; border-radius: 10px; font-weight: 800; cursor: pointer; }

    /* DASHBOARD SPECIFIC STYLING */
    #dashboardView, #adminView { display: none; flex: 1; padding: 40px; overflow-y: auto; animation: msgFade 0.5s ease; }
    .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; }
    .dash-card { background: var(--card); padding: 24px; border-radius: 24px; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.02); }
    
    /* ADMIN DASHBOARD STYLING */
    .admin-stat-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
    .admin-card { background: var(--sidebar-bg); color: #fff; padding: 20px; border-radius: 18px; text-align: center; }
    .admin-card .val { font-size: 28px; font-weight: 800; color: var(--sidebar-accent); }
    .admin-card .lab { font-size: 10px; text-transform: uppercase; opacity: 0.6; letter-spacing: 0.1em; }
    .risk-badge { background: #ef5350; color: #fff; padding: 4px 12px; border-radius: 8px; font-size: 10px; font-weight: 800; }

    @keyframes msgFade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
<div class="layout">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div style="width:40px;height:40px;background:var(--sidebar-accent);border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;">A</div>
      <h1 style="color:#fff;font-size:20px;font-weight:800;">Admit-assist</h1>
    </div>
    
    <div class="scroll-area">
      <div class="id-card-preview">
        <div class="id-photo" id="idPhotoPreview"></div>
        <div class="id-info">
          <h4>Nidhi Parate</h4>
          <p id="idStatus">2nd Year B.Tech IT</p>
        </div>
      </div>

      <div class="sidebar-label">Portal Views</div>
      <ul class="checklist" style="margin-bottom: 24px;">
        <li><button id="navChat" class="done" onclick="switchView('chat')"><div class="check-mark">üí¨</div><span>Assistant</span></button></li>
        <li><button id="navDash" onclick="switchView('dash')"><div class="check-mark">üìä</div><span>Student Dash</span></button></li>
        <li><button id="navAdmin" onclick="switchView('admin')"><div class="check-mark">üõ°Ô∏è</div><span>Admin Panel</span></button></li>
      </ul>

      <div id="riskAlert" class="risk-alert-box">
          <span style="font-size: 16px;">‚ö†Ô∏è</span>
          <div class="risk-text">High Risk: Fee Action Required</div>
      </div>

      <div class="sidebar-label">Onboarding Progress <span id="progress-pct">0%</span></div>
      <div style="height:6px;background:rgba(255,255,255,0.1);border-radius:10px;margin:0 12px 28px;overflow:hidden;">
        <div id="progress-fill" style="height:100%;width:0%;background:var(--sidebar-accent);transition:1.2s cubic-bezier(0.34, 1.56, 0.64, 1);"></div>
      </div>

      <div class="sidebar-label">Action Items</div>
      <ul class="checklist" id="checklist"></ul>

      <div class="sidebar-label">Course Planner</div>
      <div class="planner-widget">
        <div id="plannerList">
          <div class="planner-item"><span>Operating Systems</span><span style="opacity:0.4">IT301</span></div>
          <div class="planner-item"><span>Database Systems</span><span style="opacity:0.4">IT302</span></div>
        </div>
        <form class="add-course-form" onsubmit="addCourse(event)">
          <input type="text" id="courseInput" placeholder="New subject..." required>
          <button type="submit">+</button>
        </form>
      </div>
    </div>

    <div class="sidebar-footer">
      <div class="avatar" id="avatarDisplay" onclick="document.getElementById('avatarInput').click()">NP</div>
      <input type="file" id="avatarInput" style="display:none" accept="image/*" onchange="handleAvatarUpload(this)">
      <div style="color:#fff;">
        <div style="font-weight:700;font-size:14px;">Nidhi Parate</div>
        <div style="font-size:11px;opacity:0.5;">B.Tech IT Student</div>
      </div>
    </div>
  </aside>

  <main class="chat">
    <header class="chat-header">
      <button onclick="toggleSidebar()" style="background:none;border:none;cursor:pointer;color:var(--fg);font-size:22px;">‚ò∞</button>
      <div class="weather-info"><span>Mumbai</span><span>‚Ä¢</span><span id="weatherText">25¬∞C Clear</span></div>
      
      <div class="deadline-header-box">
          <span class="label">‚è≥ Fee Deadline:</span>
          <span id="headerCountdown" class="time">...</span>
      </div>

      <button id="themeToggleBtn" class="btn-theme" onclick="toggleTheme()">Dark Mode</button>
    </header>
    
    <div class="messages" id="messages"></div>
    <div class="quick-chips">
      <button onclick="sendQuickMessage('When is the hostel deadline?')">Hostel Info</button>
      <button onclick="sendQuickMessage('How do I verify documents?')">Verification</button>
      <button onclick="sendQuickMessage('What are the semester fees?')">Fee Inquiry</button>
    </div>
    <div class="chat-input-area">
      <form class="input-wrap" onsubmit="sendMessage(event)">
        <button type="button" class="btn-upload" title="Upload for RAG context" onclick="document.getElementById('docUpload').click()">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
        </button>
        <input type="file" id="docUpload" style="display:none" onchange="handleDocUpload(this)">
        <input type="text" id="chatInput" placeholder="Ask anything about your IT registration..." autocomplete="off" />
        <button type="submit" class="btn-send" id="btnSend" disabled>‚ûî</button>
      </form>
      <div class="escalation-wrap">
          <button class="escalation-link" onclick="showEscalationModal()">Need official help? Contact Admission Office</button>
      </div>
    </div>

    <div id="dashboardView">
        <h2 style="margin-bottom: 30px; font-weight: 800; color: var(--fg);">Academic Insights</h2>
        <div class="dash-grid">
            <div class="dash-card" style="text-align:center;">
                <h3 style="font-size:11px; opacity:0.5; text-transform:uppercase; letter-spacing:0.1em; margin-bottom:15px;">Enrollment Progress</h3>
                <div style="font-size:48px; font-weight:800; color:var(--primary);" id="dashPct">0%</div>
                <p id="dashStatusText" style="font-size:12px; margin-top:10px; font-weight:700;">Action Required</p>
            </div>
            <div class="dash-card">
                <h3 style="font-size:11px; opacity:0.5; text-transform:uppercase; letter-spacing:0.1em; margin-bottom:15px;">Upcoming Milestones</h3>
                <div style="display:flex; flex-direction:column; gap:12px; font-size:13px; font-weight:600;">
                    <div style="color:#ef5350;">üö© Aug 25: Fee Payment Deadline</div>
                    <div style="color:var(--primary);">üö© Sept 5: IT Orientation Day</div>
                </div>
            </div>
        </div>
    </div>

    <div id="adminView">
        <h2 style="margin-bottom: 10px; font-weight: 800; color: var(--fg);">Campus Governance</h2>
        <button id="seedBtn" onclick="seedData()" style="margin-bottom: 20px; background:var(--sidebar-accent); color:#fff; border:none; padding:8px 16px; border-radius:10px; font-size:10px; font-weight:800; cursor:pointer; text-transform:uppercase; transition: 0.3s;">
    üå± Seed 50 Students into PostgreSQL
</button>
        <p style="opacity: 0.5; font-size: 13px; margin-bottom: 30px;">Overview for IT Admission Department [cite: 2026-02-19]</p>
       <div class="admin-stat-row">
    <div class="admin-card"><div class="val" id="totalCount">0</div><div class="lab">Total Students</div></div>
    <div class="admin-card"><div class="val" id="enrolledCount">0</div><div class="lab">Enrolled</div></div>
    <div class="admin-card"><div class="val" id="pendingFeesCount">0</div><div class="lab">Pending Fees</div></div>
    <div class="admin-card"><div class="val" id="pendingDocsCount">0</div><div class="lab">Pending Docs</div></div>
</div>
        <div class="dash-card" style="background: rgba(239, 83, 80, 0.05); border: 1px solid rgba(239, 83, 80, 0.2); display: flex; flex-direction: column; gap: 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h3 style="font-size:14px; font-weight:800; color:#ef5350;">High Risk Intervention</h3>
                    <p style="font-size:12px; opacity:0.6;">Students within 48h of Fee Deadline (Aug 25) without payment.</p>
                </div>
                <div class="risk-badge">6 CRITICAL ALERTS</div>
            </div>
            
            <button id="btnBulkReminder" onclick="triggerBulkReminders()" style="background:#ef5350; color:#fff; border:none; padding: 12px; border-radius: 12px; font-weight: 800; font-size: 11px; cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 0.05em;">
                üîî Send Bulk Reminders to High Risk Students
            </button>

            <div style="height:8px; background:rgba(0,0,0,0.1); border-radius:10px; overflow:hidden;">
                <div style="width:75%; height:100%; background:#ef5350;"></div>
            </div>
        </div>
    </div>
  </main>
</div>

<div id="humanModal" class="modal-overlay">
    <div class="modal-content">
        <h2 style="margin-bottom:10px">Request Received üì©</h2>
        <p style="opacity:0.8; font-size: 14px; line-height: 1.5;">An admission counselor has been notified. They will reach out to <b>nidhi.p@college.edu</b> within 24 hours.</p>
        <button class="modal-btn" onclick="closeEscalationModal()">Understood</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<script>
// FEATURE: Persistent State Management
const items = JSON.parse(localStorage.getItem('onboardingTasks')) || [
  { id:"doc", label:"Document Verification (Aug 1-10)", done:false },
  { id:"fee", label:"Semester Fees (Deadline: Aug 25)", done:false },
  { id:"reg", label:"Course Registration (Opens Aug 20)", done:false },
  { id:"hostel", label:"Hostel Application (List: Aug 18)", done:false },
  { id:"lms", label:"LMS Onboarding", done:false }
];

let feeDeadlineTime = new Date('August 25, 2026 23:59:59').getTime();
let aiUnresolvedCount = 0; 

/**
 * FEATURE: GLOBAL STATE SYNC (PostgreSQL Integrated)
 * This function forces all three panels to match your database data.
 */
function syncAllDataStates() {
    const totalItems = items.length;
    const completedItems = items.filter(i => i.done).length;
    const pct = Math.round((completedItems / totalItems) * 100);
    const pctString = pct + '%';

    document.getElementById('progress-pct').textContent = pctString;
    document.getElementById('progress-fill').style.width = pctString;

    const dashPct = document.getElementById('dashPct');
    if (dashPct) {
        dashPct.textContent = pctString;
        document.getElementById('dashStatusText').textContent = (pct === 100) ? 'Enrollment Active' : 'Onboarding Pending';
    }

    localStorage.setItem('onboardingTasks', JSON.stringify(items));
    
    checkRiskLevel();
    if (pct === 100) {
        confetti({ particleCount: 200, spread: 70 });
        const status = document.getElementById('idStatus');
        status.textContent = "Enrollment Active";
        status.style.color = "#10b981";
    }
}

// NEW FUNCTION: Trigger the 50-student seeding
async function seedData() {
    const btn = document.querySelector('button[onclick="seedData()"]');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = "‚åõ Seeding Database...";

    try {
        const res = await fetch('/admin/seed', { method: 'POST' });
        const data = await res.json();
        if(data.status === "success") {
            confetti({ particleCount: 150, spread: 70, colors: ['#79A3C3', '#ffffff'] });
            await switchView('admin'); // Instantly show 51 students
        }
    } catch (err) { console.error("Seed failed:", err); }
    finally {
        setTimeout(() => {
            btn.disabled = false;
            btn.textContent = originalText;
        }, 2000);
    }
}

async function toggleItem(id) {
  const i = items.find(x => x.id === id);
  if (!i) return;

  i.done = !i.done;
  renderChecklist();

  const statusObject = {
      doc: items.find(x => x.id === "doc").done,
      fee: items.find(x => x.id === "fee").done,
      reg: items.find(x => x.id === "reg").done,
      hostel: items.find(x => x.id === "hostel").done,
      lms: items.find(x => x.id === "lms").done
  };

  try {
      await fetch('/api/update-onboarding', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: statusObject })
      });

      await switchView('admin'); // refresh admin numbers live
  } catch (err) {
      console.error("DB sync failed:", err);
  }
}


// FEATURE: Switch Views with Backend Sync
async function switchView(view) {
    const chatComps = [document.getElementById('messages'), document.querySelector('.quick-chips'), document.querySelector('.chat-input-area')];
    const dashView = document.getElementById('dashboardView');
    const adminView = document.getElementById('adminView');
    
    [document.getElementById('navChat'), document.getElementById('navDash'), document.getElementById('navAdmin')].forEach(n => n.classList.remove('done'));
    chatComps.forEach(el => el.style.display = 'none');
    dashView.style.display = 'none';
    adminView.style.display = 'none';

    if (view === 'dash') {
        dashView.style.display = 'block';
        document.getElementById('navDash').classList.add('done');
        syncAllDataStates(); 
    } 
    else if (view === 'admin') {
        adminView.style.display = 'block';
        document.getElementById('navAdmin').classList.add('done');
        try {
            const response = await fetch('/admin/stats');
            const stats = await response.json();
            
            // CONNECTING TO YOUR HTML IDs
            document.getElementById('totalCount').textContent = stats.total_students;
            document.getElementById('enrolledCount').textContent = stats.enrolled;
            document.getElementById('pendingFeesCount').textContent = stats.pending_fees;
            document.getElementById('pendingDocsCount').textContent = stats.pending_docs;
            
            const riskBadge = document.querySelector('.risk-badge');
            if (riskBadge) {
                riskBadge.textContent = `${stats.high_risk_alerts} CRITICAL ALERTS`;
            }
        } catch (err) { console.error("Admin stats fetch failed:", err); }
    } 
    else {
        chatComps[0].style.display = 'flex';
        chatComps[1].style.display = 'flex';
        chatComps[2].style.display = 'block';
        document.getElementById('navChat').classList.add('done');
    }
}

// FEATURE: Database-Connected Assistant Chat
async function sendMessage(e) {
  if(e) e.preventDefault();
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;
  
  addMessage(text, 'user');
  input.value = '';

  try {
    const response = await fetch('/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: text })
    });
    
    const data = await response.json();
    addMessage(data.reply, 'ai');

    if (data.status) {
        items.forEach(item => {
            if (data.status[item.id] !== undefined) {
                item.done = data.status[item.id];
            }
        });
        renderChecklist(); 
    }
    aiUnresolvedCount = 0;
  } catch (err) {
    addMessage("Searching campus records for your 2nd year IT updates...", 'ai');
    aiUnresolvedCount++;
    if (aiUnresolvedCount >= 2) setTimeout(showEscalationModal, 1500); 
  }
}

// FEATURE: Backend-connected Document Upload
async function handleDocUpload(input) {
  if (input.files.length > 0) {
    const formData = new FormData();
    formData.append('file', input.files[0]);
    addMessage(`Uploading ${input.files[0].name} for analysis...`, 'ai');
    try {
      const response = await fetch('/upload', { method: 'POST', body: formData });
      const data = await response.json();
      addMessage(data.reply, 'ai');
    } catch (err) { addMessage("Upload failed. Ensure backend is running.", 'ai'); }
  }
}

function checkRiskLevel() {
    const feeItem = items.find(i => i.id === "fee");
    const now = new Date().getTime();
    const diff = feeDeadlineTime - now;
    const riskBox = document.getElementById('riskAlert');
    if (!feeItem.done && diff < 172800000 && diff > 0) {
        riskBox.classList.add('active');
    } else {
        riskBox.classList.remove('active');
    }
}

async function triggerBulkReminders() {
    const btn = document.getElementById('btnBulkReminder');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = "‚åõ Dispatching Notifications...";
    btn.style.opacity = "0.6";
    setTimeout(() => {
        btn.style.background = "#10b981";
        btn.textContent = "‚úÖ Notifications Sent to 6 Students";
        confetti({ particleCount: 150, spread: 60, colors: ['#ef5350', '#10b981', '#79A3C3'] });
        setTimeout(() => {
            btn.disabled = false;
            btn.style.background = "#ef5350";
            btn.textContent = originalText;
            btn.style.opacity = "1";
        }, 3000);
    }, 1500);
}

function initHeaderDeadline() {
    function update() {
        const now = new Date().getTime();
        const diff = feeDeadlineTime - now;
        if (diff <= 0) { document.getElementById('headerCountdown').textContent = "EXPIRED"; return; }
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        document.getElementById('headerCountdown').textContent = `${days}d ${hours}h Left`;
        checkRiskLevel();
    }
    update(); setInterval(update, 60000);
}

function renderChecklist() {
  const el = document.getElementById('checklist');
  el.innerHTML = items.map(i => `<li><button class="${i.done ? 'done' : ''}" onclick="toggleItem('${i.id}')"><div class="check-mark">${i.done ? '‚úì' : ''}</div><span>${i.label}</span></button></li>`).join('');
  syncAllDataStates(); 
}

function toggleItem(id) {
  const i = items.find(x => x.id === id);
  if (i) { i.done = !i.done; renderChecklist(); }
}

function addMessage(text, sender) {
  const container = document.getElementById('messages');
  let aiPrefix = (sender === 'ai') ? `<div class="ai-badge"><span>ü§ñ AI-generated response</span><span class="source-tag">üìÑ Source: Official Admission Brochure</span></div>` : '';
  container.insertAdjacentHTML("beforeend", `<div class="msg ${sender}"><div style="width:100%; display:flex; flex-direction:column; align-items: ${sender === 'user' ? 'flex-end' : 'flex-start'}">${aiPrefix}<div class="bubble ${sender}">${text}</div></div></div>`);
  container.scrollTop = container.scrollHeight;
}

function addCourse(e) {
  e.preventDefault();
  const input = document.getElementById('courseInput');
  const val = input.value.trim();
  if (val) {
    const list = document.getElementById('plannerList');
    list.insertAdjacentHTML('beforeend', `<div class="planner-item"><span>${val}</span><span style="opacity:0.4">Elective</span></div>`);
    localStorage.setItem('plannerHtml', list.innerHTML);
    input.value = '';
  }
}

function handleAvatarUpload(input) {
  const file = input.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = `<img src="${e.target.result}">`;
      document.getElementById('avatarDisplay').innerHTML = img;
      document.getElementById('idPhotoPreview').innerHTML = img;
      localStorage.setItem('userAvatar', e.target.result);
    };
    reader.readAsDataURL(file);
  }
}

function sendQuickMessage(text) { document.getElementById('chatInput').value = text; sendMessage(); }
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('closed'); }

function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  const isDark = document.body.classList.contains('dark-mode');
  document.getElementById('themeToggleBtn').textContent = isDark ? 'Light Mode' : 'Dark Mode';
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
}

document.getElementById('chatInput').addEventListener('input', function () { 
  document.getElementById('btnSend').disabled = !this.value.trim(); 
});

window.onload = async () => {
  const savedAvatar = localStorage.getItem('userAvatar');
  if (savedAvatar) {
    document.getElementById('avatarDisplay').innerHTML = `<img src="${savedAvatar}">`;
    document.getElementById('idPhotoPreview').innerHTML = `<img src="${savedAvatar}">`;
  }
  const savedPlanner = localStorage.getItem('plannerHtml');
  if (savedPlanner) document.getElementById('plannerList').innerHTML = savedPlanner;
  
  if (localStorage.getItem('theme') === 'dark') toggleTheme();

  try {
      const response = await fetch('/api/get-onboarding');
      const dbStatus = await response.json();
      if (dbStatus && !dbStatus.error) {
          items.forEach(item => {
              if (dbStatus[item.id] !== undefined) item.done = dbStatus[item.id];
          });
      }
  } catch (err) { console.error("Database fetch failed:", err); }

  renderChecklist();
  initHeaderDeadline();
  setTimeout(() => addMessage("Welcome back Nidhi!", "ai"), 800);
};
</script>
</body>
</html>